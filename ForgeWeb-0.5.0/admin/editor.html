<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Load common elements -->
    <script src="/js/buildly-head.js"></script>
    
    <title>Content Editor - Buildly AI Content Manager</title>
    <meta name="description" content="AI-powered content editor for creating and editing articles.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Admin-specific styles -->
    <link rel="stylesheet" href="css/admin.css">
    
    <style>
        .admin-container {
            display: flex;
            height: 100vh;
            background: #f8fafc;
        }
        
        .sidebar {
            width: 250px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #1b5fa3 0%, #144a84 100%);
            color: white;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .sidebar h1 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .nav-item {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        
        .editor-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .editor-body {
            flex: 1;
            display: flex;
            gap: 1px;
            background: #e5e7eb;
            min-height: 0;
        }
        
        .editor-main {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            min-width: 0;
        }
        
        .editor-toolbar {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .editor-content {
            flex: 1;
            display: flex;
            gap: 1px;
            background: #e5e7eb;
            min-height: 0;
        }
        
        .editor-input {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            min-width: 0;
        }
        
        .editor-preview {
            flex: 1;
            background: white;
            overflow: auto;
            padding: 1rem;
            min-width: 0;
        }
        
        .editor-textarea {
            flex: 1;
            border: none;
            padding: 1rem;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            overflow: auto;
            min-height: 0;
        }
        
        .editor-sidebar {
            width: 300px;
            flex-shrink: 0;
            background: white;
            padding: 1rem;
            overflow: auto;
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }
        
        .meta-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .meta-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 60px;
        }
        
        .ai-panel {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .ai-panel-header {
            background: #f9fafb;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
        }
        
        .ai-panel-content {
            padding: 0.75rem;
        }
        
        .ai-prompt {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            min-height: 60px;
            resize: vertical;
        }
        
        .ai-suggestions {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ai-suggestion {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .suggestion-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.25rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: #1b5fa3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #144a84;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-accent {
            background: #f9943b;
            color: white;
        }
        
        .btn-accent:hover {
            background: #f97316;
        }
        
        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .status-bar {
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .word-count {
            display: flex;
            gap: 1rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .editor-body {
                flex-direction: column;
            }
            
            .editor-content {
                flex-direction: column;
            }
            
            .editor-sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body class="font-sans">
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>Content Editor</h1>
            
            <nav>
                <a href="index.html" class="nav-item">
                    <span>Dashboard</span>
                </a>
                <a href="index.html#files" class="nav-item">
                    <span>File Browser</span>
                </a>
                <a href="#" class="nav-item" style="background: rgba(255,255,255,0.15);">
                    <span>Article Editor</span>
                </a>
                <a href="page-editor.html" class="nav-item">
                    <span>Page Editor</span>
                </a>
                <a href="articles-manager.html" class="nav-item">
                    <span>Articles Manager</span>
                </a>
                <a href="social.html" class="nav-item">
                    <span>Social Media</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span>Settings</span>
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Editor Header -->
            <div class="editor-header">
                <div class="editor-title" id="editor-title">New Article</div>
                <div class="editor-actions">
                    <button class="btn btn-secondary" onclick="saveAsDraft()">Save Draft</button>
                    <button class="btn btn-success" onclick="saveAndPublish()">Save & Publish</button>
                    <button class="btn btn-accent" onclick="generateSocial()">Generate Social</button>
                </div>
            </div>
            
            <!-- Editor Body -->
            <div class="editor-body">
                <!-- Main Editor -->
                <div class="editor-main">
                    <!-- Toolbar -->
                    <div class="editor-toolbar">
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('*', '*')" title="Italic">I</button>
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('## ', '')" title="Heading">H2</button>
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('### ', '')" title="Heading">H3</button>
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('- ', '')" title="List">List</button>
                        <button class="btn btn-xs btn-secondary" onclick="insertMarkdown('[', '](url)')" title="Link">Link</button>
                        <span style="margin: 0 0.5rem; color: #d1d5db;">|</span>
                        <button class="btn btn-xs btn-primary" onclick="generateWithAI()">AI Generate</button>
                        <button class="btn btn-xs btn-accent" onclick="improveWithAI()">AI Improve</button>
                    </div>
                    
                    <!-- Content Area -->
                    <div class="editor-content">
                        <!-- Input -->
                        <div class="editor-input">
                            <textarea 
                                id="content-editor" 
                                class="editor-textarea" 
                                placeholder="Start writing your article content here...
                                
You can use Markdown formatting:
# Heading 1
## Heading 2
**Bold text**
*Italic text*
- List item
[Link text](URL)

Use the AI tools to help generate and improve your content!"
                                oninput="updatePreview(); updateWordCount(); autoSave();"
                            ></textarea>
                        </div>
                        
                        <!-- Preview -->
                        <div class="editor-preview">
                            <div id="content-preview">
                                <p class="text-gray-500">Content preview will appear here...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Bar -->
                    <div class="status-bar">
                        <div class="word-count">
                            <span>Words: <span id="word-count">0</span></span>
                            <span>Characters: <span id="char-count">0</span></span>
                            <span>Reading time: <span id="reading-time">0</span> min</span>
                        </div>
                        <div>
                            <span id="save-status">Ready</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="editor-sidebar">
                    <!-- Article Metadata -->
                    <div class="sidebar-section">
                        <h3>Article Details</h3>
                        <input type="text" id="article-title" class="meta-input" placeholder="Article title..." onchange="updateTitle()">
                        <textarea id="article-description" class="meta-textarea" placeholder="Article description for SEO..." onchange="autoSave()"></textarea>
                        <input type="text" id="article-keywords" class="meta-input" placeholder="Keywords (comma separated)" onchange="autoSave()">
                        <select id="article-category" class="meta-input" onchange="autoSave()">
                            <option value="">Select category</option>
                            <!-- Categories will be populated from site config -->
                        </select>
                    </div>
                    
                    <!-- Publishing Settings -->
                    <div class="sidebar-section">
                        <h3>Publishing Settings</h3>
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Save Location</label>
                            <select id="save-folder" class="meta-input" onchange="updateFilename()">
                                <!-- Folders will be populated from site config -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Filename</label>
                            <input type="text" id="article-filename" class="meta-input" placeholder="article-filename.html" onchange="autoSave()">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Index File to Update</label>
                            <select id="index-file" class="meta-input">
                                <option value="articles.html">articles.html</option>
                                <option value="index.html">index.html</option>
                                <option value="">Don't update index</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="auto-update-index" checked>
                            <label class="text-sm">Auto-update index when publishing</label>
                        </div>
                    </div>
                    
                    <!-- AI Assistant -->
                    <div class="sidebar-section">
                        <div class="ai-panel">
                            <div class="ai-panel-header">AI Assistant</div>
                            <div class="ai-panel-content">
                                <textarea id="ai-prompt" class="ai-prompt" placeholder="Ask AI to help with your content...
Examples:
- Write an introduction about [topic]
- Expand on the benefits of [concept]
- Create a conclusion for this article
- Improve the tone of this paragraph"></textarea>
                                <div class="flex gap-2 mb-4">
                                    <button class="btn btn-xs btn-primary" onclick="askAI()">Ask AI</button>
                                    <button class="btn btn-xs btn-secondary" onclick="clearSuggestions()">Clear</button>
                                </div>
                                
                                <div id="ai-loading" class="loading">
                                    <div>AI is thinking...</div>
                                </div>
                                
                                <div id="ai-suggestions" class="ai-suggestions">
                                    <!-- AI suggestions will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="sidebar-section">
                        <h3>Quick Actions</h3>
                        <div class="flex flex-col gap-2">
                            <button class="btn btn-xs btn-secondary" onclick="generateTitle()">Generate Title</button>
                            <button class="btn btn-xs btn-secondary" onclick="generateDescription()">Generate Description</button>
                            <button class="btn btn-xs btn-secondary" onclick="generateKeywords()">Generate Keywords</button>
                            <button class="btn btn-xs btn-accent" onclick="previewSocial()">Preview Social Posts</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/ai-service.js"></script>
    <script src="js/file-manager.js"></script>
    <script src="js/social-service.js"></script>
    
    <script>
        // Global variables
        let currentArticle = {
            filename: '',
            title: '',
            content: '',
            description: '',
            keywords: '',
            isNew: false
        };
        
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;
        
        // Initialize site configuration
        async function initializeSiteConfig() {
            try {
                if (window.configManager && window.configManager.initialize) {
                    await window.configManager.initialize();
                }
            } catch (error) {
                console.log('Site config initialization failed, using defaults:', error);
            }
            
            // Always populate options (with defaults if needed)
            populateConfigOptions();
        }
        
        // Populate dropdowns from site config
        function populateConfigOptions() {
            const siteConfig = window.configManager ? window.configManager.getSiteConfig() : null;
            
            // Populate categories
            const categorySelect = document.getElementById('article-category');
            categorySelect.innerHTML = '<option value="">Select category</option>';
            
            if (siteConfig && siteConfig.content && siteConfig.content.categories) {
                siteConfig.content.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } else {
                // Default categories
                const defaultCategories = [
                    {id: 'AI', name: 'Artificial Intelligence'},
                    {id: 'Product Management', name: 'Product Management'},
                    {id: 'Development', name: 'Development'},
                    {id: 'Business', name: 'Business'},
                    {id: 'Technology', name: 'Technology'}
                ];
                defaultCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
            
            // Populate folders
            const folderSelect = document.getElementById('save-folder');
            folderSelect.innerHTML = '';
            
            if (siteConfig && siteConfig.content && siteConfig.content.folders) {
                siteConfig.content.folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    folderSelect.appendChild(option);
                });
                // Set default folder
                folderSelect.value = siteConfig.content.articlesFolder || 'articles/';
            } else {
                // Default folders
                const defaultFolders = [
                    {id: 'articles/', name: 'articles/'},
                    {id: '', name: 'root folder'},
                    {id: 'blog/', name: 'blog/'},
                    {id: 'content/', name: 'content/'}
                ];
                defaultFolders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    folderSelect.appendChild(option);
                });
                folderSelect.value = 'articles/';
            }
            
            // Update index file option
            const indexSelect = document.getElementById('index-file');
            if (indexSelect) {
                const indexFile = (siteConfig && siteConfig.content && siteConfig.content.indexFile) ? siteConfig.content.indexFile : 'articles.html';
                indexSelect.innerHTML = `
                    <option value="${indexFile}">${indexFile}</option>
                    <option value="index.html">index.html</option>
                    <option value="">Don't update index</option>
                `;
            }
            
            console.log('Config options populated');
        }
        
        // Parse URL parameters
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('new') === 'true') {
                currentArticle.isNew = true;
                currentArticle.title = decodeURIComponent(urlParams.get('title') || '');
                currentArticle.filename = decodeURIComponent(urlParams.get('filename') || '');
                
                document.getElementById('article-title').value = currentArticle.title;
                document.getElementById('editor-title').textContent = currentArticle.title || 'New Article';
                
                // Set default folder and filename
                document.getElementById('save-folder').value = 'articles/';
                if (currentArticle.filename) {
                    document.getElementById('article-filename').value = currentArticle.filename;
                } else {
                    updateFilename();
                }
                
                // Set initial content template
                const initialContent = generateInitialContent(currentArticle.title);
                document.getElementById('content-editor').value = initialContent;
                updatePreview();
                updateWordCount();
            } else {
                // Load existing file
                const filePath = urlParams.get('file');
                if (filePath) {
                    loadExistingFile(filePath);
                }
            }
        }
        
        // Generate initial content for new articles
        function generateInitialContent(title) {
            return `# ${title}

## Introduction

Write your introduction here...

## Main Content

### Key Points

- Point 1
- Point 2
- Point 3

### Details

Expand on your main content here...

## Conclusion

Summarize your key takeaways...`;
        }
        
        // Load existing file
        async function loadExistingFile(filePath) {
            try {
                console.log(`üìñ Loading existing file: ${filePath}`);
                
                if (!window.fileManager) {
                    throw new Error('FileManager not initialized');
                }
                
                const content = await fileManager.readFile(filePath);
                console.log(`üìÑ File content loaded: ${content.length} characters`);
                console.log(`üìÑ First 500 chars:`, content.substring(0, 500));
                
                const metadata = fileManager.extractMetadata(content);
                console.log('üè∑Ô∏è Extracted metadata:', metadata);
                
                currentArticle.filename = filePath;
                currentArticle.title = metadata.title || '';
                currentArticle.description = metadata.description || '';
                currentArticle.keywords = (metadata.keywords || []).join(', ');
                currentArticle.isNew = false;
                
                console.log('üìù Current article data:', currentArticle);
                
                // Extract content from HTML
                const bodyMatch = content.match(/<main[^>]*>(.*?)<\/main>/s);
                const articleMatch = content.match(/<article[^>]*>(.*?)<\/article>/s);
                let articleContent = '';
                
                console.log('üîç Body match found:', !!bodyMatch);
                console.log('üîç Article match found:', !!articleMatch);
                
                if (articleMatch) {
                    articleContent = articleMatch[1];
                    console.log('üìù Using article content:', articleContent.substring(0, 200));
                } else if (bodyMatch) {
                    articleContent = bodyMatch[1];
                    console.log('üìù Using body content:', articleContent.substring(0, 200));
                } else {
                    // Fallback: try to find any content between body tags
                    const fallbackMatch = content.match(/<body[^>]*>(.*?)<\/body>/s);
                    if (fallbackMatch) {
                        articleContent = fallbackMatch[1];
                        console.log('üìù Using fallback body content:', articleContent.substring(0, 200));
                    }
                }
                
                console.log('üìù Raw article content length:', articleContent.length);
                
                // Convert HTML to Markdown (simplified)
                articleContent = htmlToMarkdown(articleContent);
                console.log('üìù Converted markdown length:', articleContent.length);
                console.log('üìù First 200 chars of markdown:', articleContent.substring(0, 200));
                
                // Update UI
                console.log('üîÑ Updating UI with metadata...');
                document.getElementById('article-title').value = currentArticle.title;
                document.getElementById('article-description').value = currentArticle.description;
                document.getElementById('article-keywords').value = currentArticle.keywords;
                document.getElementById('content-editor').value = articleContent;
                document.getElementById('editor-title').textContent = currentArticle.title || 'Article Editor';
                
                // Also update filename field
                const filenameOnly = filePath.replace(/^.*\//, '');
                document.getElementById('article-filename').value = filenameOnly;
                
                console.log('‚úÖ UI updated with metadata');
                updatePreview();
                updateWordCount();
                
            } catch (error) {
                showNotification('Failed to load file: ' + error.message, 'error');
            }
        }
        
        // Simple HTML to Markdown conversion
        function htmlToMarkdown(html) {
            return html
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
                .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                .replace(/<ul[^>]*>(.*?)<\/ul>/gi, '$1\n')
                .replace(/<ol[^>]*>(.*?)<\/ol>/gi, '$1\n')
                .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
                .replace(/<[^>]+>/g, '') // Remove remaining HTML tags
                .replace(/\n\s*\n\s*\n/g, '\n\n') // Clean up multiple newlines
                .trim();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Auto-save on content change
            document.getElementById('content-editor').addEventListener('input', function() {
                hasUnsavedChanges = true;
                scheduleAutoSave();
            });
            
            // Prevent leaving with unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveAsDraft();
                }
            });
        }
        
        // Update preview
        function updatePreview() {
            const content = document.getElementById('content-editor').value;
            const preview = document.getElementById('content-preview');
            
            // Simple Markdown to HTML conversion
            const html = markdownToHtml(content);
            preview.innerHTML = html || '<p class="text-gray-500">Content preview will appear here...</p>';
        }
        
        // Simple Markdown to HTML conversion
        function markdownToHtml(markdown) {
            return markdown
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.*)$/gm, '<p>$1</p>')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
                .replace(/<p><ul>/g, '<ul>')
                .replace(/<\/ul><\/p>/g, '</ul>')
                .replace(/<p><\/p>/g, '');
        }
        
        // Update word count
        function updateWordCount() {
            const content = document.getElementById('content-editor').value;
            const words = content.trim().split(/\s+/).filter(word => word.length > 0);
            const chars = content.length;
            const readingTime = Math.ceil(words.length / 200); // 200 WPM
            
            document.getElementById('word-count').textContent = words.length;
            document.getElementById('char-count').textContent = chars;
            document.getElementById('reading-time').textContent = readingTime;
        }
        
        // Update title
        function updateTitle() {
            const title = document.getElementById('article-title').value;
            currentArticle.title = title;
            document.getElementById('editor-title').textContent = title || 'Article Editor';
            updateFilename();
            hasUnsavedChanges = true;
            scheduleAutoSave();
        }
        
        // Update filename based on title and folder
        function updateFilename() {
            const title = document.getElementById('article-title').value;
            const folder = document.getElementById('save-folder').value;
            
            if (title && !document.getElementById('article-filename').value) {
                const slug = title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .replace(/-+/g, '-') // Replace multiple hyphens with single
                    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
                
                document.getElementById('article-filename').value = slug + '.html';
                currentArticle.filename = folder + slug + '.html';
            }
        }
        
        // Insert markdown
        function insertMarkdown(before, after) {
            const textarea = document.getElementById('content-editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            const replacement = before + selectedText + after;
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            
            // Set cursor position
            const newPos = start + before.length + selectedText.length;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();
            
            updatePreview();
            hasUnsavedChanges = true;
            scheduleAutoSave();
        }
        
        // Schedule auto-save
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            autoSaveTimer = setTimeout(() => {
                autoSave();
            }, 3000); // Auto-save after 3 seconds of inactivity
        }
        
        // Auto-save
        function autoSave() {
            if (!hasUnsavedChanges) return;
            
            updateSaveStatus('Auto-saving...');
            
            // In a real implementation, this would save to backend
            setTimeout(() => {
                updateSaveStatus('Auto-saved');
                hasUnsavedChanges = false;
            }, 500);
        }
        
        // Save as draft
        async function saveAsDraft() {
            updateSaveStatus('Saving draft...');
            
            try {
                const articleData = gatherArticleData();
                
                // Generate HTML content
                const htmlContent = generateArticleHTML(articleData);
                
                // Save file as draft (add draft- prefix)
                const draftFilename = 'draft-' + articleData.filename;
                const draftPath = articleData.folder + draftFilename;
                
                if (!window.fileManager) {
                    throw new Error('File manager not available');
                }
                
                const result = await fileManager.writeFile(draftPath, htmlContent);
            
            updateSaveStatus(result.downloaded ? 'Draft downloaded' : 'Draft saved');
            hasUnsavedChanges = false;
            
            if (result.downloaded) {
                const draftInstructions = `
DRAFT SAVED:

File downloaded as: ${draftPath}

To continue working:
1. Upload this draft file to your website's ${articleData.folder} folder for backup
2. Or keep it locally and continue editing in this editor
3. When ready, use "Save & Publish" to create the final version

The draft contains all your current content and can be uploaded as-is for preview.
                `;
                
                addAISuggestion(draftInstructions, 'Draft Instructions');
                showNotification(`Draft downloaded as ${draftPath}. Check instructions below.`, 'success');
            } else {
                showNotification(`Draft saved to ${draftPath}!`, 'success');
            }
            
            } catch (error) {
                updateSaveStatus('Error');
                showNotification('Draft save failed: ' + error.message, 'error');
            }
        }
        
        // Save and publish
        async function saveAndPublish() {
            updateSaveStatus('Publishing...');
            
            try {
                const articleData = gatherArticleData();
                
                // Validate required fields
                if (!articleData.title.trim()) {
                    showNotification('Please enter a title before publishing', 'error');
                    return;
                }
                
                if (!articleData.filename.trim()) {
                    showNotification('Please enter a filename before publishing', 'error');
                    return;
                }
                
                // Generate HTML content
                const htmlContent = generateArticleHTML(articleData);
                
                // Save article file
                const fullPath = articleData.folder + articleData.filename;
                
                if (!window.fileManager) {
                    throw new Error('File manager not available');
                }
                
                const result = await fileManager.writeFile(fullPath, htmlContent);
                
                // Update index if requested
                const autoUpdate = document.getElementById('auto-update-index').checked;
                const indexFile = document.getElementById('index-file').value;
                
                if (autoUpdate && indexFile) {
                    await updateArticleIndex(articleData, indexFile);
                }
                
                updateSaveStatus(result.downloaded ? 'Downloaded' : 'Published');
                hasUnsavedChanges = false;
                
                if (result.downloaded) {
                    // Show instructions for manual upload
                    showPublishInstructions(articleData, fullPath, autoUpdate && indexFile);
                    showNotification(`Article downloaded as ${fullPath}. Check instructions below.`, 'success');
                } else {
                    // File was saved successfully
                    if (autoUpdate && indexFile) {
                        showIndexUpdateInstructions(generateIndexUpdateInfo(articleData), indexFile);
                    }
                    
                    // Auto-update articles.html if saving to articles folder
                    if (articleData.folder === 'articles/') {
                        try {
                            await updateArticlesPage();
                            showNotification(`Article published to ${fullPath} and articles page updated!`, 'success');
                        } catch (error) {
                            console.error('Failed to update articles page:', error);
                            showNotification(`Article published to ${fullPath}! (Warning: Failed to update articles page)`, 'success');
                        }
                    } else {
                        showNotification(`Article published to ${fullPath}!`, 'success');
                    }
                }
                
            } catch (error) {
                updateSaveStatus('Error');
                showNotification('Publishing failed: ' + error.message, 'error');
            }
        }
        
        // Gather article data
        function gatherArticleData() {
            const folder = document.getElementById('save-folder').value || 'articles/';
            const filename = document.getElementById('article-filename').value || 'new-article.html';
            
            const data = {
                title: document.getElementById('article-title').value || 'Untitled Article',
                description: document.getElementById('article-description').value || '',
                keywords: document.getElementById('article-keywords').value || '',
                category: document.getElementById('article-category').value || '',
                content: document.getElementById('content-editor').value || '',
                folder: folder,
                filename: filename,
                fullPath: folder + filename,
                slug: filename.replace('.html', '')
            };
            
            console.log('Gathered article data:', data);
            return data;
        }
        
        // Generate article HTML
        function generateArticleHTML(data) {
            const slug = data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const currentDate = new Date().toISOString().split('T')[0];
            const contentHtml = markdownToHtml(data.content);
            
            console.log('Generating HTML for:', data.title);
            console.log('Content length:', data.content.length);
            
            if (!window.fileManager) {
                throw new Error('File manager not available for template generation');
            }
            
            return fileManager.generateArticleFromTemplate(data.title, contentHtml);
        }
        
        // Update save status
        function updateSaveStatus(status) {
            document.getElementById('save-status').textContent = status;
        }
        
        // AI functions
        async function generateWithAI() {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt.trim()) {
                showNotification('Please enter a prompt for AI generation', 'error');
                return;
            }
            
            showAILoading(true);
            
            try {
                const response = await aiService.generateContent(prompt, {
                    taskType: 'draft',
                    maxTokens: 500,
                    temperature: 0.7
                });
                
                addAISuggestion(response.content, 'Generated content');
                
            } catch (error) {
                showNotification('AI generation failed: ' + error.message, 'error');
            } finally {
                showAILoading(false);
            }
        }
        
        async function improveWithAI() {
            const selectedText = getSelectedText();
            const content = selectedText || document.getElementById('content-editor').value;
            
            if (!content.trim()) {
                showNotification('No content to improve', 'error');
                return;
            }
            
            showAILoading(true);
            
            try {
                const response = await aiService.generateSuggestions(content, 'improve');
                addAISuggestion(response.content, 'Improved content');
                
            } catch (error) {
                showNotification('AI improvement failed: ' + error.message, 'error');
            } finally {
                showAILoading(false);
            }
        }
        
        async function askAI() {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt.trim()) {
                showNotification('Please enter a question or request', 'error');
                return;
            }
            
            showAILoading(true);
            
            try {
                const response = await aiService.generateContent(prompt, {
                    taskType: 'general',
                    maxTokens: 300,
                    temperature: 0.7
                });
                
                addAISuggestion(response.content, 'AI Response');
                document.getElementById('ai-prompt').value = '';
                
            } catch (error) {
                showNotification('AI request failed: ' + error.message, 'error');
            } finally {
                showAILoading(false);
            }
        }
        
        // Show AI loading state
        function showAILoading(show) {
            document.getElementById('ai-loading').style.display = show ? 'block' : 'none';
        }
        
        // Add AI suggestion
        function addAISuggestion(content, label) {
            const suggestionsContainer = document.getElementById('ai-suggestions');
            
            const suggestion = document.createElement('div');
            suggestion.className = 'ai-suggestion';
            suggestion.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 0.5rem;">${label}</div>
                <div style="margin-bottom: 0.5rem;">${content}</div>
                <div class="suggestion-actions">
                    <button class="btn btn-xs btn-primary" onclick="insertSuggestion(this, '${content.replace(/'/g, "\\'")}')">Insert</button>
                    <button class="btn btn-xs btn-secondary" onclick="replaceSuggestion(this, '${content.replace(/'/g, "\\'")}')">Replace</button>
                    <button class="btn btn-xs btn-secondary" onclick="copySuggestion('${content.replace(/'/g, "\\'")}')">Copy</button>
                </div>
            `;
            
            suggestionsContainer.appendChild(suggestion);
        }
        
        // Insert suggestion
        function insertSuggestion(button, content) {
            const textarea = document.getElementById('content-editor');
            const cursorPos = textarea.selectionStart;
            
            textarea.value = textarea.value.substring(0, cursorPos) + '\n\n' + content + '\n\n' + textarea.value.substring(cursorPos);
            
            updatePreview();
            updateWordCount();
            hasUnsavedChanges = true;
            
            button.closest('.ai-suggestion').remove();
        }
        
        // Replace suggestion
        function replaceSuggestion(button, content) {
            const textarea = document.getElementById('content-editor');
            const selectedText = getSelectedText();
            
            if (selectedText) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, start) + content + textarea.value.substring(end);
            } else {
                textarea.value = content;
            }
            
            updatePreview();
            updateWordCount();
            hasUnsavedChanges = true;
            
            button.closest('.ai-suggestion').remove();
        }
        
        // Copy suggestion
        async function copySuggestion(content) {
            try {
                await navigator.clipboard.writeText(content);
                showNotification('Content copied to clipboard!', 'success');
            } catch (error) {
                showNotification('Failed to copy to clipboard', 'error');
            }
        }
        
        // Get selected text
        function getSelectedText() {
            const textarea = document.getElementById('content-editor');
            return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        }
        
        // Clear suggestions
        function clearSuggestions() {
            document.getElementById('ai-suggestions').innerHTML = '';
            document.getElementById('ai-prompt').value = '';
        }
        
        // Quick actions
        async function generateTitle() {
            const content = document.getElementById('content-editor').value;
            if (!content.trim()) {
                showNotification('No content to generate title from', 'error');
                return;
            }
            
            try {
                const response = await aiService.generateContent(
                    `Create an engaging, SEO-optimized title for this article. The title should:
- Be 50-60 characters long (for SEO)
- Be compelling and click-worthy
- Include the main benefit or value proposition
- Use active language
- Be relevant to software development, AI, or business topics

Article Content:
${content.substring(0, 800)}

Return ONLY the title text, no quotes or extra formatting.`,
                    { taskType: 'general', maxTokens: 40, temperature: 0.6 }
                );
                
                // Clean the title
                let cleanTitle = response.content
                    .replace(/^["']|["']$/g, '') // Remove quotes
                    .replace(/^\s*-\s*/, '') // Remove leading dash
                    .trim();
                
                document.getElementById('article-title').value = cleanTitle;
                updateTitle();
                
            } catch (error) {
                showNotification('Failed to generate title: ' + error.message, 'error');
            }
        }
        
        async function generateDescription() {
            const content = document.getElementById('content-editor').value;
            const title = document.getElementById('article-title').value;
            const button = event.target;
            const originalText = button.textContent;
            
            if (!content.trim()) {
                showNotification('No content to generate description from', 'error');
                return;
            }
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '‚è≥ Generating...';
                showNotification('ü§ñ AI is generating description...', 'info');
                
                console.log('üöÄ Starting description generation...');
                const startTime = Date.now();
                
                const response = await aiService.generateContent(
                    `Write a compelling SEO meta description (150-160 characters) for this article. The description should:
- Be engaging and encourage clicks
- Include the main topic/benefit
- Use active voice
- End with a call-to-action or benefit statement
- Be exactly 150-160 characters (not longer)

Article Title: "${title}"

Article Content Preview:
${content.substring(0, 800)}

Return ONLY the meta description text, no quotes or extra formatting.`,
                    { taskType: 'general', maxTokens: 80, temperature: 0.6 }
                );
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Description generated in ${duration}s:`, response.content);
                
                // Clean and validate the response
                let cleanDescription = response.content
                    .replace(/^["']|["']$/g, '') // Remove quotes
                    .replace(/^\s*-\s*/, '') // Remove leading dash
                    .trim();
                
                // Truncate if too long
                if (cleanDescription.length > 160) {
                    cleanDescription = cleanDescription.substring(0, 157) + '...';
                }
                
                document.getElementById('article-description').value = cleanDescription;
                hasUnsavedChanges = true;
                showNotification(`‚úÖ Description generated in ${duration}s!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Description generation failed:', error);
                showNotification('Failed to generate description: ' + error.message, 'error');
            } finally {
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        async function generateKeywords() {
            const content = document.getElementById('content-editor').value;
            const title = document.getElementById('article-title').value;
            const button = event.target;
            const originalText = button.textContent;
            
            if (!content.trim()) {
                showNotification('No content to generate keywords from', 'error');
                return;
            }
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '‚è≥ Generating...';
                showNotification('ü§ñ AI is generating keywords...', 'info');
                
                console.log('üöÄ Starting keyword generation...');
                const startTime = Date.now();
                
                const response = await aiService.generateContent(
                    `Generate relevant SEO keywords for this article. Return 8-12 keywords/phrases that:
- Are relevant to the main topic and content
- Include a mix of short (1-2 words) and long-tail (3-4 words) keywords
- Focus on terms people would search for
- Include technical terms and business terms where appropriate
- Are separated by commas with no extra formatting

Article Title: "${title}"

Article Content:
${content.substring(0, 1000)}

Return ONLY the keywords separated by commas, no quotes, bullets, or numbering.`,
                    { taskType: 'general', maxTokens: 120, temperature: 0.4 }
                );
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Keywords generated in ${duration}s:`, response.content);
                
                // Clean and format the keywords
                let cleanKeywords = response.content
                    .replace(/^["']|["']$/g, '') // Remove quotes
                    .replace(/^\s*-\s*/, '') // Remove leading dash
                    .replace(/\n/g, '') // Remove line breaks
                    .replace(/\s*,\s*/g, ', ') // Normalize comma spacing
                    .replace(/[.;]/g, ',') // Replace other punctuation with commas  
                    .replace(/,+/g, ',') // Remove duplicate commas
                    .replace(/^,|,$/, '') // Remove leading/trailing commas
                    .trim();
                
                document.getElementById('article-keywords').value = cleanKeywords;
                hasUnsavedChanges = true;
                showNotification(`‚úÖ Keywords generated in ${duration}s!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Keyword generation failed:', error);
                showNotification('Failed to generate keywords: ' + error.message, 'error');
            } finally {
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Generate social posts
        function generateSocial() {
            const title = document.getElementById('article-title').value;
            const content = document.getElementById('content-editor').value;
            
            if (!title || !content.trim()) {
                showNotification('Please add a title and content before generating social posts', 'error');
                return;
            }
            
            // Redirect to social media manager with content
            const params = new URLSearchParams({
                title: title,
                content: content.substring(0, 1000) // Limit content for URL
            });
            
            window.open(`social.html?${params.toString()}`, '_blank');
        }
        
        // Preview social posts
        async function previewSocial() {
            const title = document.getElementById('article-title').value;
            const content = document.getElementById('content-editor').value;
            
            if (!title || !content.trim()) {
                showNotification('Please add a title and content first', 'error');
                return;
            }
            
            try {
                const posts = await socialMediaService.generateAllPosts(content, { title });
                
                let preview = 'Social Media Preview:\n\n';
                for (const [platform, post] of Object.entries(posts)) {
                    if (!post.error) {
                        preview += `${platform.toUpperCase()}:\n${post.content}\n${post.hashtags.join(' ')}\n\n`;
                    }
                }
                
                addAISuggestion(preview, 'Social Media Preview');
                
            } catch (error) {
                showNotification('Failed to generate social preview: ' + error.message, 'error');
            }
        }
        
        // Update article index
        async function updateArticleIndex(articleData, indexFile) {
            try {
                // For now, we'll provide instructions to the user
                // In a full implementation, this would read, parse, and update the HTML
                
                const indexUpdateInfo = generateIndexUpdateInfo(articleData);
                
                // Show instructions to user
                showIndexUpdateInstructions(indexUpdateInfo, indexFile);
                
                // In a real implementation, you'd:
                // 1. Read the index file
                // 2. Parse the HTML to find the appropriate section
                // 3. Insert the new article card HTML
                // 4. Write the updated index back
                
            } catch (error) {
                console.error('Failed to update index:', error);
                showNotification('Article saved but index update failed: ' + error.message, 'warning');
            }
        }
        
        // Generate index update information
        function generateIndexUpdateInfo(articleData) {
            const categoryMap = {
                'AI': 'Artificial Intelligence',
                'Product Management': 'Product Management',
                'Development': 'Development',
                'Business': 'Business',
                'Technology': 'Technology'
            };
            
            const categoryName = categoryMap[articleData.category] || 'General';
            const categoryClass = articleData.category === 'AI' ? 'buildly-accent' : 'buildly-primary';
            
            return {
                category: articleData.category,
                categoryName: categoryName,
                categoryClass: categoryClass,
                title: articleData.title,
                description: articleData.description,
                url: articleData.fullPath,
                cardHtml: `
                    <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-${categoryClass} text-white px-2 py-1 rounded text-xs">${articleData.category}</span>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">${articleData.title}</h4>
                        <p class="text-gray-600 text-sm mb-4">${articleData.description}</p>
                        <a href="${articleData.fullPath}" class="text-buildly-primary font-medium hover:text-buildly-secondary">Read More ‚Üí</a>
                    </div>`
            };
        }
        
        // Show index update instructions
        function showIndexUpdateInstructions(updateInfo, indexFile) {
            const instructions = `
To complete the publishing process, add this HTML to ${indexFile} in the "${updateInfo.categoryName}" section:

${updateInfo.cardHtml}

The article has been saved to: ${updateInfo.url}
            `;
            
            addAISuggestion(instructions, 'Index Update Instructions');
        }
        
        // Show publishing instructions
        function showPublishInstructions(articleData, fullPath, updateIndex) {
            const instructions = `
PUBLISHING INSTRUCTIONS:

1. UPLOAD THE ARTICLE FILE:
   - Download completed: ${fullPath}
   - Upload this file to your website's ${articleData.folder} folder
   - The file is ready to publish at: https://www.buildly.io/${fullPath}

2. ${updateIndex ? 'UPDATE THE ARTICLES INDEX:' : 'OPTIONAL - UPDATE ARTICLES INDEX:'}
   ${updateIndex ? '(Instructions provided below)' : '(You can manually add to articles.html later)'}

3. VERIFY DEPLOYMENT:
   - Check that the article loads at: https://www.buildly.io/${fullPath}
   - Verify it appears in the articles index if updated

The article HTML file has been generated with:
‚úì Proper SEO meta tags
‚úì Open Graph and Twitter Cards
‚úì Structured data for rich snippets  
‚úì Buildly branding and navigation
‚úì Mobile-responsive design

Your article is ready for production!
            `;
            
            addAISuggestion(instructions, 'Publishing Instructions');
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg fixed top-4 right-4 z-50 max-w-sm`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Update articles.html page automatically
        async function updateArticlesPage() {
            try {
                console.log('üîÑ Auto-updating articles.html page...');
                
                // Get current featured article (or use default)
                let featuredArticle = {
                    title: "From MVP to Market Leader: Navigating the Product Lifecycle",
                    description: "This article examines every phase of the product lifecycle offering best practices to achieve market leadership and sustainable growth.",
                    link: "articles/product-lifecycle.html",
                    category: "Product Management"
                };
                
                // Try to load stored featured article
                try {
                    const featuredResponse = await fetch('/.featured-article.json');
                    if (featuredResponse.ok) {
                        featuredArticle = await featuredResponse.json();
                    }
                } catch (e) {
                    console.log('Using default featured article');
                }
                
                // Call the regenerate API
                const response = await fetch('/api/regenerate-articles-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ featuredArticle })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to regenerate articles page: ${response.status}`);
                }
                
                console.log('‚úÖ Articles page updated successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to update articles page:', error);
                throw error;
            }
        }
        
        // Initialize editor
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Editor initializing...');
            
            // Wait a bit for scripts to load
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await initializeSiteConfig();
            parseURLParams();
            setupEventListeners();
            updatePreview();
            updateWordCount();
            
            console.log('Editor initialization complete');
        });
    </script>
</body>
</html>
