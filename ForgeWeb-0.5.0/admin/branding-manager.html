<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branding Manager - ForgeWeb Admin</title>
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'buildly-dark': '#1b5fa3',
                        'buildly-light': '#144a84',
                        'buildly-accent': '#f9943b'
                    }
                }
            }
        }
    </script>
</head>

<body class="font-sans bg-gray-50" data-page="branding">
    <div class="admin-container">
        <!-- Navigation Sidebar -->
        <div id="admin-nav" class="h-full"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div>
                    <h2 class="text-2xl font-bold text-buildly-dark">Branding Manager</h2>
                    <p class="text-gray-600">Customize your website's visual identity</p>
                </div>
                <button class="bg-buildly-dark hover:bg-buildly-light text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2" onclick="saveAllBranding()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    <span id="save-status">Save All Changes</span>
                </button>
            </div>

            <!-- Brand Colors Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        üé® Brand Colors
                        <span class="ml-2 text-sm text-gray-500">Define your color palette</span>
                    </h3>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="color-input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                            <div class="flex items-center space-x-3">
                                <input type="color" id="primaryColor" value="#1b5fa3" 
                                       class="w-12 h-12 rounded-lg border-2 border-gray-300 cursor-pointer">
                                <input type="text" id="primaryColorHex" value="#1b5fa3" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Main brand color for buttons and headings</p>
                        </div>
                        
                        <div class="color-input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Secondary Color</label>
                            <div class="flex items-center space-x-3">
                                <input type="color" id="secondaryColor" value="#144a84" 
                                       class="w-12 h-12 rounded-lg border-2 border-gray-300 cursor-pointer">
                                <input type="text" id="secondaryColorHex" value="#144a84" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Hover states and secondary elements</p>
                        </div>
                        
                        <div class="color-input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                            <div class="flex items-center space-x-3">
                                <input type="color" id="accentColor" value="#f9943b" 
                                       class="w-12 h-12 rounded-lg border-2 border-gray-300 cursor-pointer">
                                <input type="text" id="accentColorHex" value="#f9943b" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Highlights and call-to-action elements</p>
                        </div>
                    </div>
                    
                    <!-- Color Preview -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Color Preview</h4>
                        <div class="flex flex-wrap gap-3">
                            <div class="color-preview-card">
                                <div id="primaryPreview" class="w-16 h-16 rounded-lg shadow-sm" style="background-color: #1b5fa3;"></div>
                                <span class="text-xs text-gray-600 mt-1">Primary</span>
                            </div>
                            <div class="color-preview-card">
                                <div id="secondaryPreview" class="w-16 h-16 rounded-lg shadow-sm" style="background-color: #144a84;"></div>
                                <span class="text-xs text-gray-600 mt-1">Secondary</span>
                            </div>
                            <div class="color-preview-card">
                                <div id="accentPreview" class="w-16 h-16 rounded-lg shadow-sm" style="background-color: #f9943b;"></div>
                                <span class="text-xs text-gray-600 mt-1">Accent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logo Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        üñºÔ∏è Logo & Branding Assets
                        <span class="ml-2 text-sm text-gray-500">Upload and manage your logo</span>
                    </h3>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Logo Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website Logo</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" 
                                 id="logoDropZone"
                                 ondrop="handleLogoDrop(event)" 
                                 ondragover="event.preventDefault()" 
                                 ondragenter="event.preventDefault()">
                                
                                <div id="logoUploadArea" class="space-y-4">
                                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Drag and drop your logo here, or</p>
                                        <button type="button" class="mt-2 btn btn-secondary" onclick="document.getElementById('logoInput').click()">
                                            Browse Files
                                        </button>
                                        <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                                    </div>
                                    <p class="text-xs text-gray-500">SVG, PNG, JPG up to 2MB. Recommended: 400x100px</p>
                                </div>
                                
                                <div id="logoPreviewArea" class="hidden">
                                    <img id="logoPreview" class="mx-auto max-h-32 rounded-lg shadow-sm" alt="Logo Preview">
                                    <div class="mt-4 flex justify-center space-x-2">
                                        <button class="btn btn-secondary btn-sm" onclick="changeLogoFile()">Change</button>
                                        <button class="btn btn-accent btn-sm" onclick="removeLogo()">Remove</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Logo Settings -->
                            <div class="mt-4 space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Logo Alt Text</label>
                                    <input type="text" id="logoAltText" value="Company Logo" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                           placeholder="Describe your logo for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Favicon Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Favicon</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" id="faviconDropZone">
                                <div id="faviconUploadArea" class="space-y-4">
                                    <div class="mx-auto w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Upload favicon</p>
                                        <button type="button" class="mt-2 btn btn-secondary btn-sm" onclick="document.getElementById('faviconInput').click()">
                                            Browse
                                        </button>
                                        <input type="file" id="faviconInput" accept="image/x-icon,image/png" class="hidden" onchange="handleFaviconUpload(this)">
                                    </div>
                                    <p class="text-xs text-gray-500">ICO or PNG, 32x32px recommended</p>
                                </div>
                                
                                <div id="faviconPreviewArea" class="hidden">
                                    <img id="faviconPreview" class="mx-auto w-8 h-8" alt="Favicon Preview">
                                    <div class="mt-3">
                                        <button class="btn btn-secondary btn-sm" onclick="changeFaviconFile()">Change</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typography & Styling -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        üî§ Typography & Style
                        <span class="ml-2 text-sm text-gray-500">Font and styling options</span>
                    </h3>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Font Family</label>
                            <select id="fontFamily" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="system">System Default</option>
                                <option value="inter">Inter (Google Fonts)</option>
                                <option value="roboto">Roboto (Google Fonts)</option>
                                <option value="opensans">Open Sans (Google Fonts)</option>
                                <option value="lato">Lato (Google Fonts)</option>
                                <option value="montserrat">Montserrat (Google Fonts)</option>
                                <option value="custom">Custom Font URL</option>
                            </select>
                            
                            <div id="customFontUrl" class="hidden mt-2">
                                <input type="url" id="customFontUrlInput" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       placeholder="https://fonts.googleapis.com/css2?family=...">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Border Radius Style</label>
                            <select id="borderRadius" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="none">Sharp (0px)</option>
                                <option value="sm">Small (4px)</option>
                                <option value="md" selected>Medium (8px)</option>
                                <option value="lg">Large (12px)</option>
                                <option value="xl">Extra Large (16px)</option>
                                <option value="full">Rounded (50%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Style Preview -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Style Preview</h4>
                        <div id="stylePreview" class="space-y-3">
                            <div class="p-3 bg-white rounded shadow-sm border">
                                <h5 class="font-semibold text-lg" style="color: var(--primary-color)">Sample Heading</h5>
                                <p class="text-gray-600 mt-2">This is how your content will look with the selected typography and colors.</p>
                                <button class="mt-3 px-4 py-2 text-white rounded" style="background-color: var(--primary-color)">Sample Button</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom CSS -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        üíª Custom CSS
                        <span class="ml-2 text-sm text-gray-500">Advanced styling customization</span>
                    </h3>
                </div>
                
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional CSS Rules</label>
                        <p class="text-sm text-gray-500 mb-3">Add custom CSS to further customize your website's appearance.</p>
                    </div>
                    
                    <textarea id="customCSS" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm" 
                              rows="12" 
                              placeholder="/* Add your custom CSS here */
.my-custom-class {
    color: #333;
    font-size: 1.2rem;
}

/* Example: Custom button style */
.btn-custom {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
}"></textarea>
                    
                    <div class="mt-3 flex items-center justify-between">
                        <p class="text-xs text-gray-500">CSS will be applied to all pages on your website</p>
                        <button class="btn btn-secondary btn-sm" onclick="validateCSS()">Validate CSS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold">Branding Updated!</h3>
            </div>
            <p class="text-gray-600 mb-4">Your branding changes have been saved successfully.</p>
            <div class="flex justify-end space-x-2">
                <button class="btn btn-secondary" onclick="closeSuccessModal()">Close</button>
                <button class="btn btn-primary" onclick="previewSite()">Preview Site</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Color input synchronization
        function setupColorInputs() {
            const colorInputs = [
                { color: 'primary', hex: 'primaryColorHex', preview: 'primaryPreview' },
                { color: 'secondary', hex: 'secondaryColorHex', preview: 'secondaryPreview' },
                { color: 'accent', hex: 'accentColorHex', preview: 'accentPreview' }
            ];

            colorInputs.forEach(input => {
                const colorPicker = document.getElementById(input.color + 'Color');
                const hexInput = document.getElementById(input.hex);
                const preview = document.getElementById(input.preview);

                // Color picker change
                colorPicker.addEventListener('input', function() {
                    hexInput.value = this.value;
                    preview.style.backgroundColor = this.value;
                    updateStylePreview();
                });

                // Hex input change
                hexInput.addEventListener('input', function() {
                    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                        colorPicker.value = this.value;
                        preview.style.backgroundColor = this.value;
                        updateStylePreview();
                    }
                });
            });
        }

        function updateStylePreview() {
            const primary = document.getElementById('primaryColorHex').value;
            const secondary = document.getElementById('secondaryColorHex').value;
            const accent = document.getElementById('accentColorHex').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const borderRadius = document.getElementById('borderRadius').value;
            
            // Update CSS custom properties
            document.documentElement.style.setProperty('--primary-color', primary);
            document.documentElement.style.setProperty('--secondary-color', secondary);
            document.documentElement.style.setProperty('--accent-color', accent);
            
            // Update style preview specifically
            const preview = document.getElementById('stylePreview');
            const sampleButton = preview.querySelector('button');
            const sampleHeading = preview.querySelector('h5');
            
            if (sampleButton) {
                sampleButton.style.backgroundColor = primary;
                sampleButton.style.borderRadius = getBorderRadiusValue(borderRadius);
            }
            
            if (sampleHeading) {
                sampleHeading.style.color = primary;
                sampleHeading.style.fontFamily = getFontFamilyValue(fontFamily);
            }
            
            // Update preview container border radius
            const previewCard = preview.querySelector('.border');
            if (previewCard) {
                previewCard.style.borderRadius = getBorderRadiusValue(borderRadius);
            }
        }
        
        function getBorderRadiusValue(setting) {
            const radiusMap = {
                'none': '0px',
                'sm': '4px',
                'md': '8px',
                'lg': '12px',
                'xl': '16px',
                'full': '50%'
            };
            return radiusMap[setting] || '8px';
        }
        
        function getFontFamilyValue(setting) {
            const fontMap = {
                'system': 'system-ui, -apple-system, sans-serif',
                'inter': 'Inter, system-ui, sans-serif',
                'roboto': 'Roboto, system-ui, sans-serif',
                'opensans': 'Open Sans, system-ui, sans-serif',
                'lato': 'Lato, system-ui, sans-serif',
                'montserrat': 'Montserrat, system-ui, sans-serif',
                'custom': 'Custom Font, system-ui, sans-serif'
            };
            return fontMap[setting] || 'system-ui, -apple-system, sans-serif';
        }

        // Logo handling
        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 2 * 1024 * 1024) {
                    alert('Logo file size must be less than 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoPreview').src = e.target.result;
                    document.getElementById('logoUploadArea').classList.add('hidden');
                    document.getElementById('logoPreviewArea').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function handleLogoDrop(e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const input = document.getElementById('logoInput');
                input.files = files;
                handleLogoUpload(input);
            }
        }

        function changeLogoFile() {
            document.getElementById('logoInput').click();
        }

        function removeLogo() {
            document.getElementById('logoInput').value = '';
            document.getElementById('logoUploadArea').classList.remove('hidden');
            document.getElementById('logoPreviewArea').classList.add('hidden');
        }

        // Favicon handling
        function handleFaviconUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('faviconPreview').src = e.target.result;
                    document.getElementById('faviconUploadArea').classList.add('hidden');
                    document.getElementById('faviconPreviewArea').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function changeFaviconFile() {
            document.getElementById('faviconInput').click();
        }

        // Font family handling
        document.getElementById('fontFamily').addEventListener('change', function() {
            const customUrlDiv = document.getElementById('customFontUrl');
            if (this.value === 'custom') {
                customUrlDiv.classList.remove('hidden');
            } else {
                customUrlDiv.classList.add('hidden');
            }
            updateStylePreview();
        });
        
        // Border radius handling
        document.getElementById('borderRadius').addEventListener('change', function() {
            updateStylePreview();
        });

        // Save all branding
        async function saveAllBranding() {
            const saveButton = document.getElementById('save-status');
            saveButton.textContent = 'Saving...';
            
            try {
                const brandingData = {
                    colors: {
                        primary: document.getElementById('primaryColorHex').value,
                        secondary: document.getElementById('secondaryColorHex').value,
                        accent: document.getElementById('accentColorHex').value
                    },
                    typography: {
                        fontFamily: document.getElementById('fontFamily').value,
                        customFontUrl: document.getElementById('customFontUrlInput').value,
                        borderRadius: document.getElementById('borderRadius').value
                    },
                    assets: {
                        logoAltText: document.getElementById('logoAltText').value
                    },
                    customCSS: document.getElementById('customCSS').value
                };

                // Save to backend
                const response = await fetch('/api/branding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(brandingData)
                });

                if (response.ok) {
                    saveButton.textContent = 'Saved!';
                    setTimeout(() => saveButton.textContent = 'Save All Changes', 2000);
                    showSuccessModal();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                saveButton.textContent = 'Save Failed';
                setTimeout(() => saveButton.textContent = 'Save All Changes', 2000);
                alert('Failed to save branding changes: ' + error.message);
            }
        }

        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        function previewSite() {
            window.open('/', '_blank');
            closeSuccessModal();
        }

        function validateCSS() {
            // Basic CSS validation
            const css = document.getElementById('customCSS').value;
            try {
                // Simple validation - check for balanced braces
                const openBraces = (css.match(/{/g) || []).length;
                const closeBraces = (css.match(/}/g) || []).length;
                
                if (openBraces === closeBraces) {
                    alert('CSS appears to be valid!');
                } else {
                    alert('CSS validation warning: Unbalanced braces detected');
                }
            } catch (error) {
                alert('CSS validation error: ' + error.message);
            }
        }

        // Load existing branding settings
        async function loadBrandingSettings() {
            try {
                const response = await fetch('/api/branding');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Apply loaded settings to form
                    if (settings.colors) {
                        const primaryColor = settings.colors.primary || '#1b5fa3';
                        const secondaryColor = settings.colors.secondary || '#144a84';
                        const accentColor = settings.colors.accent || '#f9943b';
                        
                        document.getElementById('primaryColor').value = primaryColor;
                        document.getElementById('primaryColorHex').value = primaryColor;
                        document.getElementById('secondaryColor').value = secondaryColor;
                        document.getElementById('secondaryColorHex').value = secondaryColor;
                        document.getElementById('accentColor').value = accentColor;
                        document.getElementById('accentColorHex').value = accentColor;
                    }
                    
                    if (settings.typography) {
                        document.getElementById('fontFamily').value = settings.typography.fontFamily || 'system';
                        document.getElementById('borderRadius').value = settings.typography.borderRadius || 'md';
                        
                        if (settings.typography.customFontUrl) {
                            document.getElementById('customFontUrlInput').value = settings.typography.customFontUrl;
                        }
                    }
                    
                    if (settings.assets) {
                        if (settings.assets.logoAltText) {
                            document.getElementById('logoAltText').value = settings.assets.logoAltText;
                        }
                    }
                    
                    if (settings.customCSS) {
                        document.getElementById('customCSS').value = settings.customCSS;
                    }
                    
                    // Update previews
                    updateStylePreview();
                }
            } catch (error) {
                console.error('Failed to load branding settings:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load navigation first
            fetch('includes/nav.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('admin-nav').innerHTML = html;
                })
                .catch(error => console.error('Error loading navigation:', error));
            
            // Set up the page
            setupColorInputs();
            updateStylePreview();
            loadBrandingSettings();
        });
    </script>
</body>
</html>