<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildly Page Editor - Full Page HTML Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'buildly': {
                            primary: '#1b5fa3',
                            secondary: '#144a84', 
                            accent: '#f9943b',
                            dark: '#1F2937',
                            light: '#F3F4F6',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <style>
        .CodeMirror {
            height: 100% !important;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="js/file-manager.js"></script>
</head>
<body class="font-sans bg-gray-100" data-page="page-editor">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="../media/buildly-logo.svg" alt="Buildly" class="h-8 w-auto mr-3">
                    <h1 class="text-xl font-bold text-buildly-primary">Page Editor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="saveBtn" class="bg-buildly-primary text-white px-4 py-2 rounded-md hover:bg-buildly-secondary transition-colors">
                        Save Page
                    </button>
                    <a href="editor.html" class="text-buildly-primary hover:text-buildly-secondary">Article Editor</a>
                    <a href="articles-manager.html" class="text-buildly-primary hover:text-buildly-secondary">Articles Manager</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex" style="height: calc(100vh - 4rem);">
        
        <!-- Left Panel - Navigation + AI Helper -->
        <div class="w-80 border-r border-gray-200 flex flex-col">
            <!-- Navigation Sidebar -->
            <div id="admin-nav" class="flex-shrink-0"></div>
            
            <!-- AI Helper Panel -->
            <div class="flex-1 flex flex-col bg-white" id="aiHelperPanel">
                <div class="bg-gradient-to-r from-buildly-primary to-buildly-secondary px-4 py-2 flex justify-between items-center border-t border-white border-opacity-20">
                    <h2 class="font-semibold text-white flex items-center text-sm">
                        <span class="mr-2">ü§ñ</span>
                        AI Helper
                    </h2>
                    <button 
                        id="popoutAiHelper" 
                        class="text-white hover:text-gray-200 text-xs px-2 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors"
                        title="Pop out AI Helper (Coming Soon)"
                    >
                        ‚ÜóÔ∏è Pop Out
                    </button>
                </div>
                <div class="flex-1 flex flex-col" style="min-height: 0;">
                    <!-- Chat Messages -->
                    <div id="aiChatMessages" class="flex-1 overflow-y-auto p-3 space-y-2" style="min-height: 0;">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                            <div class="text-xs text-blue-600 font-medium mb-1">AI Assistant</div>
                            <div class="text-xs text-gray-700">
                                Hi! I can help with Buildly's design system:
                                <ul class="list-disc list-inside mt-1 text-xs space-y-0.5">
                                    <li>HTML structure</li>
                                    <li>CSS classes</li>
                                    <li>Responsive design</li>
                                    <li>New sections</li>
                                </ul>
                                <div class="mt-1 text-xs text-blue-600">
                                    Just describe what you need!
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="border-t border-gray-200 p-3">
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="aiPrompt" 
                                placeholder="Ask for help..."
                                class="flex-1 border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:border-buildly-primary"
                            >
                            <button 
                                id="sendAiPrompt" 
                                class="bg-buildly-primary text-white px-3 py-1 rounded text-xs hover:bg-buildly-secondary transition-colors"
                            >
                                Send
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span id="aiStatus">Ready</span>
                            </div>
                            <button 
                                id="clearAiChat" 
                                class="text-xs text-gray-400 hover:text-gray-600"
                            >
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - HTML Editor -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">HTML Editor</h2>
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">File:</label>
                    <select id="fileSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                        <option value="">Select a page to edit...</option>
                        <option value="index.html">index.html (Homepage)</option>
                        <option value="labs.html">labs.html (Labs Page)</option>
                        <option value="use-cases.html">use-cases.html (Use Cases)</option>
                        <option value="pricing.html">pricing.html (Pricing)</option>
                        <option value="articles.html">articles.html (Articles Index)</option>
                        <option value="team.html">team.html (Team Page)</option>
                        <option value="rad-core.html">rad-core.html (RAD Core)</option>
                        <option value="rad-process.html">rad-process.html (RAD Process)</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 relative" style="min-height: 0;">
                <textarea id="htmlEditor" class="w-full h-full p-4 font-mono text-sm resize-none border-none outline-none"></textarea>
            </div>
        </div>

        <!-- Right Panel - Live Preview -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">Live Preview</h2>
                <div class="flex items-center space-x-2">
                    <button id="refreshPreview" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">
                        Refresh
                    </button>
                    <button id="openNewTab" class="bg-buildly-primary text-white px-3 py-1 rounded text-sm hover:bg-buildly-secondary">
                        Open in New Tab
                    </button>
                </div>
            </div>
            <div class="flex-1">
                <iframe id="previewFrame" class="w-full h-full border-none" sandbox="allow-scripts allow-forms"></iframe>
            </div>
        </div>

        <!-- Right Panel - Page Metadata & Navigation -->
        <div class="w-80 bg-gray-50 flex flex-col overflow-y-auto">
            <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
                <h2 class="font-semibold text-gray-800">Page Settings</h2>
            </div>
            
            <div class="p-4 space-y-6">
                <!-- Page Information -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Page Information</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Page Title</label>
                            <input type="text" id="pageTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Page title for browser tab">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
                            <textarea id="pageDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="SEO description for search engines"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keywords</label>
                            <input type="text" id="pageKeywords" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="SEO keywords, comma separated">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Canonical URL</label>
                            <input type="text" id="canonicalUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="https://www.buildly.io/page.html">
                        </div>
                    </div>
                </div>

                <!-- Navigation Settings -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Navigation & IA</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Page Type</label>
                            <select id="pageType" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="homepage">Homepage</option>
                                <option value="product">Product Page</option>
                                <option value="feature">Feature Page</option>
                                <option value="pricing">Pricing</option>
                                <option value="about">About/Team</option>
                                <option value="resources">Resources</option>
                                <option value="landing">Landing Page</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Navigation Priority</label>
                            <select id="navPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="primary">Primary Navigation</option>
                                <option value="secondary">Secondary Navigation</option>
                                <option value="footer">Footer Only</option>
                                <option value="none">Not in Navigation</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent Page</label>
                            <select id="parentPage" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">Top Level</option>
                                <option value="index.html">Homepage</option>
                                <option value="labs.html">Labs</option>
                                <option value="use-cases.html">Use Cases</option>
                                <option value="pricing.html">Pricing</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Menu Label</label>
                            <input type="text" id="menuLabel" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Text shown in navigation">
                        </div>
                    </div>
                </div>

                <!-- Social & Open Graph -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Social Media</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">OG Title</label>
                            <input type="text" id="ogTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Social media title">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">OG Description</label>
                            <textarea id="ogDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Social media description"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">OG Image</label>
                            <input type="text" id="ogImage" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="https://www.buildly.io/media/image.jpg">
                        </div>
                    </div>
                </div>

                <!-- Page Actions -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Actions</h3>
                    <div class="space-y-2">
                        <button id="updateMetadata" class="w-full bg-buildly-accent text-white py-2 px-4 rounded-md hover:bg-orange-600 transition-colors">
                            Update Metadata
                        </button>
                        <button id="validateHtml" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                            Validate HTML
                        </button>
                        <button id="exportPage" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                            Export Page
                        </button>
                    </div>
                </div>

                <!-- Recent Files -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Recent Files</h3>
                    <div id="recentFiles" class="space-y-1">
                        <p class="text-sm text-gray-500">No recent files</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="bg-gray-800 text-white px-4 py-2 text-sm flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <span id="fileStatus">No file loaded</span>
            <span id="cursorPosition">Line 1, Col 1</span>
        </div>
        <div class="flex items-center space-x-2">
            <span id="validationStatus" class="text-green-400">HTML Valid</span>
            <span>‚Ä¢</span>
            <span>Buildly Page Editor</span>
        </div>
    </div>

    <script>
        class AIHelper {
            constructor(pageEditor) {
                this.pageEditor = pageEditor;
                this.isProcessing = false;
                
                // Initialize and show status
                console.log('ü§ñ AI Assistant initialized');
                this.updateStatus('AI Ready');
                
                // Add initialization message after a brief delay
                setTimeout(() => {
                    this.addMessage('assistant', 'AI Assistant is ready! You can ask me to help with:\n\n‚Ä¢ Creating hero sections\n‚Ä¢ Adding new content sections\n‚Ä¢ Modifying existing elements\n‚Ä¢ Applying Buildly design system\n\nJust type your request and I\'ll provide specific HTML code!', null, 'info');
                }, 500);
                
                this.buildlyDesignSystem = {
                    colors: {
                        primary: '#1b5fa3',
                        secondary: '#144a84',
                        accent: '#f9943b',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    },
                    classes: {
                        buttons: ['bg-buildly-primary', 'bg-buildly-secondary', 'bg-buildly-accent', 'hover:bg-buildly-secondary'],
                        text: ['text-buildly-primary', 'text-buildly-secondary', 'text-buildly-accent', 'text-buildly-dark'],
                        backgrounds: ['bg-buildly-primary', 'bg-buildly-light', 'bg-gradient-to-r from-buildly-primary to-buildly-secondary'],
                        layout: ['max-w-7xl', 'mx-auto', 'px-4', 'sm:px-6', 'lg:px-8', 'py-20'],
                        spacing: ['space-y-4', 'space-y-8', 'space-y-12', 'space-x-4', 'gap-6', 'gap-8'],
                        typography: ['text-3xl', 'text-4xl', 'font-bold', 'font-semibold', 'text-lg', 'text-xl']
                    },
                    patterns: {
                        hero: 'Hero sections with gradient backgrounds, large headings, and CTA buttons',
                        section: 'Standard sections with max-width containers, padding, and centered content',
                        button: 'Primary buttons with buildly-primary background and hover effects',
                        card: 'Cards with white background, shadow, and rounded corners'
                    }
                };
            }

            async sendPrompt() {
                const promptInput = document.getElementById('aiPrompt');
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    this.addMessage('assistant', 'Please enter a prompt to get help!', null, 'info');
                    return;
                }
                
                if (this.isProcessing) {
                    this.addMessage('assistant', 'Please wait, I\'m still processing your previous request...', null, 'info');
                    return;
                }

                this.isProcessing = true;
                this.updateStatus('Processing...');
                
                // Add user message to chat
                this.addMessage('user', prompt);
                promptInput.value = '';

                try {
                    const response = await this.processPrompt(prompt);
                    this.addMessage('assistant', response.message, response.code);
                } catch (error) {
                    console.error('AI Assistant Error:', error);
                    this.addMessage('assistant', `Sorry, I encountered an error: ${error.message}`, null, 'error');
                } finally {
                    this.isProcessing = false;
                    this.updateStatus('Ready');
                }
            }

            async processPrompt(prompt) {
                // Get current HTML content
                const currentHtml = this.pageEditor.editor ? this.pageEditor.editor.getValue() : '';
                const currentFile = this.pageEditor.currentFile || 'unknown';

                // Create context about Buildly design system
                const systemContext = `You are an AI assistant helping with Buildly website development. 

Buildly Design System:
- Colors: Primary #1b5fa3, Secondary #144a84, Accent #f9943b
- Tailwind classes: bg-buildly-primary, text-buildly-primary, etc.
- Layout: Use max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 for containers
- Buttons: bg-buildly-primary text-white with hover:bg-buildly-secondary
- Sections: py-20 for vertical spacing
- Typography: Use Inter font family

Current file: ${currentFile}
User request: ${prompt}

Please provide specific HTML changes that follow Buildly's design system. If you suggest code changes, provide the exact HTML that should be modified or added.`;

                // For demo purposes, provide intelligent responses based on common requests
                const response = this.generateResponse(prompt, currentHtml, currentFile);
                return response;
            }

            generateResponse(prompt, currentHtml, currentFile) {
                const lowerPrompt = prompt.toLowerCase();
                
                // Analyze the prompt and provide appropriate responses
                if (lowerPrompt.includes('hero') || lowerPrompt.includes('banner')) {
                    return {
                        message: "I'll help you create a hero section with Buildly's design system. Here's a modern hero pattern:",
                        code: `<section class="relative bg-gradient-to-r from-buildly-primary to-buildly-secondary text-white py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-6">
                Build Better with AI
            </h1>
            <p class="text-xl md:text-2xl mb-8 text-white text-opacity-90 max-w-3xl mx-auto">
                Transform your development workflow with Buildly's AI-powered platform
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="https://labs.buildly.io" class="bg-buildly-accent text-white px-8 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">
                    Try for Free
                </a>
                <a href="#learn-more" class="border border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-buildly-primary transition-colors">
                    Learn More
                </a>
            </div>
        </div>
    </div>
</section>`
                    };
                }
                
                if (lowerPrompt.includes('button') || lowerPrompt.includes('cta')) {
                    return {
                        message: "Here are some Buildly-styled button examples you can use:",
                        code: `<!-- Primary Button -->
<a href="https://labs.buildly.io" class="bg-buildly-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-buildly-secondary transition-colors">
    Try for Free
</a>

<!-- Secondary Button -->
<a href="#learn-more" class="border border-buildly-accent text-buildly-accent px-8 py-3 rounded-lg font-semibold hover:bg-buildly-accent hover:text-white transition-colors">
    Learn More
</a>

<!-- Accent Button -->
<button class="bg-buildly-accent text-white px-6 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-colors">
    Get Started
</button>`
                    };
                }
                
                if (lowerPrompt.includes('section') || lowerPrompt.includes('layout')) {
                    return {
                        message: "Here's a standard Buildly section layout pattern:",
                        code: `<section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-buildly-dark mb-4">Section Title</h2>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Section description that explains what this section is about
            </p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Your content here -->
        </div>
    </div>
</section>`
                    };
                }
                
                if (lowerPrompt.includes('card') || lowerPrompt.includes('feature')) {
                    return {
                        message: "Here's a feature card component following Buildly's design:",
                        code: `<div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
    <div class="text-buildly-primary text-3xl mb-4">
        <!-- Icon here -->
        üöÄ
    </div>
    <h3 class="text-xl font-semibold text-buildly-dark mb-3">Feature Title</h3>
    <p class="text-gray-600 mb-4">
        Describe your feature benefits and how it helps users achieve their goals.
    </p>
    <a href="#" class="text-buildly-primary font-medium hover:text-buildly-secondary transition-colors">
        Learn More ‚Üí
    </a>
</div>`
                    };
                }
                
                if (lowerPrompt.includes('color') || lowerPrompt.includes('style')) {
                    return {
                        message: "Here are the Buildly color classes you can use:",
                        code: `<!-- Background Colors -->
bg-buildly-primary    <!-- #1b5fa3 -->
bg-buildly-secondary  <!-- #144a84 -->
bg-buildly-accent     <!-- #f9943b -->
bg-buildly-dark       <!-- #1F2937 -->
bg-buildly-light      <!-- #F3F4F6 -->

<!-- Text Colors -->
text-buildly-primary
text-buildly-secondary  
text-buildly-accent
text-buildly-dark

<!-- Gradients -->
bg-gradient-to-r from-buildly-primary to-buildly-secondary
bg-gradient-to-b from-buildly-primary to-buildly-secondary`
                    };
                }
                
                if (lowerPrompt.includes('mobile') || lowerPrompt.includes('responsive')) {
                    return {
                        message: "Here are Buildly's responsive design patterns:",
                        code: `<!-- Responsive Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Content -->
</div>

<!-- Responsive Text -->
<h1 class="text-2xl md:text-4xl lg:text-6xl font-bold">
    Responsive Heading
</h1>

<!-- Responsive Spacing -->
<div class="px-4 sm:px-6 lg:px-8 py-8 md:py-16 lg:py-20">
    <!-- Content -->
</div>

<!-- Responsive Flex -->
<div class="flex flex-col sm:flex-row gap-4 justify-center">
    <!-- Buttons or content -->
</div>`
                    };
                }
                
                // Default response
                return {
                    message: `I can help you with HTML and CSS changes using Buildly's design system. I can assist with:

‚Ä¢ Creating hero sections and banners
‚Ä¢ Styling buttons and CTAs  
‚Ä¢ Building responsive layouts
‚Ä¢ Adding feature cards and sections
‚Ä¢ Applying Buildly colors and typography
‚Ä¢ Making mobile-responsive designs

What specific changes would you like to make to ${currentFile || 'this page'}?`,
                    code: null
                };
            }

            addMessage(sender, message, code = null, type = 'normal') {
                const messagesContainer = document.getElementById('aiChatMessages');
                const messageDiv = document.createElement('div');
                
                const bgColor = sender === 'user' ? 'bg-gray-50 border-gray-200' : 
                               type === 'error' ? 'bg-red-50 border-red-200' : 
                               type === 'info' ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200';
                const textColor = sender === 'user' ? 'text-gray-600' : 
                                 type === 'error' ? 'text-red-600' : 
                                 type === 'info' ? 'text-green-600' : 'text-blue-600';
                
                messageDiv.className = `${bgColor} border rounded-lg p-3`;
                
                let content = `
                    <div class="text-xs ${textColor} font-medium mb-1">
                        ${sender === 'user' ? 'You' : 'AI Assistant'}
                    </div>
                    <div class="text-sm text-gray-700">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                `;
                
                if (code) {
                    content += `
                        <div class="mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-500">Suggested Code:</span>
                                <button onclick="pageEditor.aiHelper.applyCode(\`${code.replace(/`/g, '\\`')}\`)" 
                                        class="text-xs bg-buildly-primary text-white px-2 py-1 rounded hover:bg-buildly-secondary">
                                    Apply to Editor
                                </button>
                            </div>
                            <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code>${this.escapeHtml(code)}</code></pre>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = content;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            applyCode(code) {
                if (this.pageEditor.editor && code) {
                    // Get current cursor position
                    const cursor = this.pageEditor.editor.getCursor();
                    
                    // Insert the code at cursor position
                    this.pageEditor.editor.replaceSelection(code);
                    
                    // Update preview
                    this.pageEditor.updatePreview();
                    
                    // Show notification
                    this.pageEditor.showNotification('Code applied to editor', 'success');
                    
                    this.addMessage('assistant', 'Code has been applied to the editor. Check the preview to see the changes!');
                }
            }

            clearChat() {
                const messagesContainer = document.getElementById('aiChatMessages');
                // Keep only the welcome message (first child)
                while (messagesContainer.children.length > 1) {
                    messagesContainer.removeChild(messagesContainer.lastChild);
                }
            }

            updateStatus(status) {
                document.getElementById('aiStatus').textContent = status;
            }

            popOut() {
                alert('Pop-out feature coming soon! For now, use the AI helper in the sidebar.');
            }



            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }

        class PageEditor {
            constructor() {
                this.currentFile = '';
                this.editor = null;
                this.fileManager = new FileManager();
                this.recentFiles = JSON.parse(localStorage.getItem('buildly-recent-pages') || '[]');
                this.aiHelper = new AIHelper(this);
                this.initializeEditor();
                this.bindEvents();
                this.updateRecentFiles();
                this.loadAvailableFiles();
                
                // Check for file parameter in URL after editor is ready
                setTimeout(() => {
                    this.checkUrlParams();
                }, 100);
            }

            checkUrlParams() {
                console.log('Checking URL parameters...');
                const urlParams = new URLSearchParams(window.location.search);
                const fileParam = urlParams.get('file');
                console.log('URL file parameter:', fileParam);
                
                if (fileParam) {
                    // Set the file select dropdown and load the file
                    const fileSelect = document.getElementById('fileSelect');
                    console.log('File select element:', fileSelect);
                    
                    if (fileSelect) {
                        // Check if the file is in our dropdown options
                        const options = Array.from(fileSelect.options);
                        console.log('Available options:', options.map(o => o.value));
                        const matchingOption = options.find(option => option.value === fileParam);
                        
                        if (matchingOption) {
                            console.log('Found matching option, setting dropdown value');
                            fileSelect.value = fileParam;
                        } else {
                            console.log('No matching option found in dropdown, adding it dynamically');
                            // Add the file to the dropdown if it's not there
                            const newOption = document.createElement('option');
                            newOption.value = fileParam;
                            newOption.textContent = fileParam;
                            fileSelect.appendChild(newOption);
                            fileSelect.value = fileParam;
                        }
                        
                        // Load the file with a slight delay to ensure everything is ready
                        console.log('Loading file:', fileParam);
                        setTimeout(() => {
                            this.loadFile(fileParam);
                        }, 200);
                    } else {
                        console.error('File select element not found, retrying in 500ms');
                        setTimeout(() => this.checkUrlParams(), 500);
                    }
                } else {
                    console.log('No file parameter in URL');
                }
            }

            initializeEditor() {
                // Initialize CodeMirror
                this.editor = CodeMirror.fromTextArea(document.getElementById('htmlEditor'), {
                    mode: 'htmlmixed',
                    theme: 'dracula',
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseTags: true,
                    indentUnit: 2,
                    tabSize: 2,
                    extraKeys: {
                        'Ctrl-S': () => this.savePage(),
                        'Cmd-S': () => this.savePage(),
                        'F11': (cm) => {
                            cm.setOption('fullScreen', !cm.getOption('fullScreen'));
                        },
                        'Esc': (cm) => {
                            if (cm.getOption('fullScreen')) cm.setOption('fullScreen', false);
                        }
                    }
                });

                // Refresh editor after initialization to ensure proper sizing
                setTimeout(() => {
                    this.editor.refresh();
                    this.editor.focus();
                }, 100);

                // Update cursor position
                this.editor.on('cursorActivity', () => {
                    const cursor = this.editor.getCursor();
                    document.getElementById('cursorPosition').textContent = 
                        `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
                });

                // Auto-update preview
                this.editor.on('change', () => {
                    clearTimeout(this.previewTimeout);
                    this.previewTimeout = setTimeout(() => {
                        this.updatePreview();
                    }, 500);
                });
            }

            bindEvents() {
                // File selection
                document.getElementById('fileSelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.loadFile(e.target.value);
                    }
                });

                // Save button
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.savePage();
                });

                // Preview controls
                document.getElementById('refreshPreview').addEventListener('click', () => {
                    this.updatePreview();
                });

                document.getElementById('openNewTab').addEventListener('click', () => {
                    if (this.currentFile) {
                        window.open(`../${this.currentFile}`, '_blank');
                    }
                });

                // Metadata actions
                document.getElementById('updateMetadata').addEventListener('click', () => {
                    this.updateMetadataInHTML();
                });

                document.getElementById('validateHtml').addEventListener('click', () => {
                    this.validateHTML();
                });

                document.getElementById('exportPage').addEventListener('click', () => {
                    this.exportPage();
                });

                // Window resize handler to refresh CodeMirror
                window.addEventListener('resize', () => {
                    if (this.editor) {
                        setTimeout(() => this.editor.refresh(), 100);
                    }
                });

                // AI Helper events
                document.getElementById('sendAiPrompt').addEventListener('click', () => {
                    this.aiHelper.sendPrompt();
                });

                document.getElementById('aiPrompt').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.aiHelper.sendPrompt();
                    }
                });

                document.getElementById('clearAiChat').addEventListener('click', () => {
                    this.aiHelper.clearChat();
                });

                document.getElementById('popoutAiHelper').addEventListener('click', () => {
                    this.aiHelper.popOut();
                });
            }

            async loadAvailableFiles() {
                try {
                    // Get list of HTML files from the server
                    const response = await fetch('/api/list-html-files');
                    if (response.ok) {
                        const data = await response.json();
                        this.populateFileSelect(data.files || []);
                    } else {
                        console.warn('Could not load file list, using default options');
                    }
                } catch (error) {
                    console.warn('Error loading file list:', error);
                }
            }

            populateFileSelect(files) {
                const fileSelect = document.getElementById('fileSelect');
                
                // Clear existing options except the first one (Select a file...)
                while (fileSelect.options.length > 1) {
                    fileSelect.remove(1);
                }
                
                // Add files to dropdown
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = `${file.filename} (${file.description})`;
                    fileSelect.appendChild(option);
                });
                
                console.log(`Loaded ${files.length} HTML files into file selector`);
            }

            async loadFile(filename) {
                try {
                    const fileStatusEl = document.getElementById('fileStatus');
                    if (fileStatusEl) {
                        fileStatusEl.textContent = `Loading ${filename}...`;
                    }
                    console.log('Loading file:', filename);
                    
                    const response = await fetch(`../${filename}`);
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) throw new Error(`File not found: ${response.status}`);
                    
                    const content = await response.text();
                    console.log('File content length:', content.length);
                    console.log('First 100 chars:', content.substring(0, 100));
                    
                    // Make sure editor is initialized
                    if (!this.editor) {
                        console.error('Editor not initialized, waiting...');
                        setTimeout(() => this.loadFile(filename), 200);
                        return;
                    }
                    
                    this.editor.setValue(content);
                    this.currentFile = filename;
                    
                    // Extract metadata
                    this.extractMetadata(content);
                    
                    // Update preview
                    this.updatePreview();
                    
                    // Add to recent files
                    this.addToRecentFiles(filename);
                    
                    if (fileStatusEl) {
                        fileStatusEl.textContent = `Loaded: ${filename}`;
                    }
                    console.log('File loaded successfully');
                } catch (error) {
                    console.error('Error loading file:', error);
                    const fileStatusEl = document.getElementById('fileStatus');
                    if (fileStatusEl) {
                        fileStatusEl.textContent = `Error loading ${filename}: ${error.message}`;
                    }
                }
            }

            extractMetadata(html) {
                // Extract title
                const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
                if (titleMatch) {
                    document.getElementById('pageTitle').value = titleMatch[1].trim();
                }

                // Extract meta description
                const descMatch = html.match(/<meta[^>]*name="description"[^>]*content="([^"]*)"[^>]*>/i);
                if (descMatch) {
                    document.getElementById('pageDescription').value = descMatch[1];
                }

                // Extract keywords
                const keywordsMatch = html.match(/<meta[^>]*name="keywords"[^>]*content="([^"]*)"[^>]*>/i);
                if (keywordsMatch) {
                    document.getElementById('pageKeywords').value = keywordsMatch[1];
                }

                // Extract canonical URL
                const canonicalMatch = html.match(/<link[^>]*rel="canonical"[^>]*href="([^"]*)"[^>]*>/i);
                if (canonicalMatch) {
                    document.getElementById('canonicalUrl').value = canonicalMatch[1];
                }

                // Extract Open Graph data
                const ogTitleMatch = html.match(/<meta[^>]*property="og:title"[^>]*content="([^"]*)"[^>]*>/i);
                if (ogTitleMatch) {
                    document.getElementById('ogTitle').value = ogTitleMatch[1];
                }

                const ogDescMatch = html.match(/<meta[^>]*property="og:description"[^>]*content="([^"]*)"[^>]*>/i);
                if (ogDescMatch) {
                    document.getElementById('ogDescription').value = ogDescMatch[1];
                }

                const ogImageMatch = html.match(/<meta[^>]*property="og:image"[^>]*content="([^"]*)"[^>]*>/i);
                if (ogImageMatch) {
                    document.getElementById('ogImage').value = ogImageMatch[1];
                }

                // Auto-detect page type based on filename and content
                this.autoDetectPageType();
                
                // Set menu label from title if not already set
                if (!document.getElementById('menuLabel').value && titleMatch) {
                    const cleanTitle = titleMatch[1].replace(' - Buildly', '').trim();
                    document.getElementById('menuLabel').value = cleanTitle;
                }
            }

            autoDetectPageType() {
                if (!this.currentFile) return;
                
                const filename = this.currentFile.toLowerCase();
                const pageTypeSelect = document.getElementById('pageType');
                
                if (filename === 'index.html') {
                    pageTypeSelect.value = 'homepage';
                } else if (filename.includes('pricing')) {
                    pageTypeSelect.value = 'pricing';
                } else if (filename.includes('labs') || filename.includes('product')) {
                    pageTypeSelect.value = 'product';
                } else if (filename.includes('team') || filename.includes('about')) {
                    pageTypeSelect.value = 'about';
                } else if (filename.includes('use-cases') || filename.includes('feature')) {
                    pageTypeSelect.value = 'feature';
                } else if (filename.includes('articles') || filename.includes('blog')) {
                    pageTypeSelect.value = 'resources';
                } else {
                    pageTypeSelect.value = 'other';
                }
                
                // Set navigation priority
                const navPrioritySelect = document.getElementById('navPriority');
                if (['index.html', 'labs.html', 'use-cases.html', 'pricing.html'].includes(filename)) {
                    navPrioritySelect.value = 'primary';
                } else if (['team.html', 'articles.html'].includes(filename)) {
                    navPrioritySelect.value = 'secondary';
                } else {
                    navPrioritySelect.value = 'footer';
                }
            }

            updateMetadataInHTML() {
                let html = this.editor.getValue();
                
                // Update title
                const newTitle = document.getElementById('pageTitle').value;
                if (newTitle) {
                    html = html.replace(/<title[^>]*>([^<]*)<\/title>/i, `<title>${newTitle}</title>`);
                }

                // Update meta description
                const newDesc = document.getElementById('pageDescription').value;
                if (newDesc) {
                    html = html.replace(
                        /<meta[^>]*name="description"[^>]*content="[^"]*"[^>]*>/i,
                        `<meta name="description" content="${newDesc}">`
                    );
                }

                // Update keywords
                const newKeywords = document.getElementById('pageKeywords').value;
                if (newKeywords) {
                    html = html.replace(
                        /<meta[^>]*name="keywords"[^>]*content="[^"]*"[^>]*>/i,
                        `<meta name="keywords" content="${newKeywords}">`
                    );
                }

                this.editor.setValue(html);
                this.updatePreview();
            }

            async updatePreview() {
                const html = this.editor.getValue();
                const iframe = document.getElementById('previewFrame');
                
                try {
                    // Create a temporary preview file on the server
                    const response = await fetch('/api/create-preview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: html,
                            filename: this.currentFile || 'preview.html'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        // Load the preview through our preview endpoint
                        iframe.src = `/preview/${result.previewFile}?t=${Date.now()}`;
                    } else {
                        console.warn('Preview update failed, falling back to blob');
                        this.updatePreviewFallback(html);
                    }
                } catch (error) {
                    console.warn('Preview update error, falling back to blob:', error);
                    this.updatePreviewFallback(html);
                }
            }
            
            updatePreviewFallback(html) {
                const iframe = document.getElementById('previewFrame');
                
                // Fallback: Use blob URL for immediate preview (assets won't load)
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                // Clean up the blob URL after a delay
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }

            async savePage() {
                if (!this.currentFile) {
                    alert('No file selected to save');
                    return;
                }

                const html = this.editor.getValue();
                
                try {
                    const result = await this.fileManager.writeFileLocal(this.currentFile, html);
                    
                    if (result && result.success) {
                        document.getElementById('fileStatus').textContent = `Saved: ${this.currentFile}`;
                        
                        // Show success notification
                        this.showNotification('Page saved successfully!', 'success');
                    } else {
                        // Fallback to download
                        this.fileManager.downloadFile(this.currentFile, html);
                        document.getElementById('fileStatus').textContent = `Downloaded: ${this.currentFile}`;
                        this.showNotification('File downloaded (could not save directly)', 'info');
                    }
                } catch (error) {
                    console.error('Save failed:', error);
                    this.showNotification('Save failed: ' + error.message, 'error');
                }
            }

            validateHTML() {
                const html = this.editor.getValue();
                
                // Basic HTML validation
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const parserErrors = doc.getElementsByTagName('parsererror');
                
                if (parserErrors.length > 0) {
                    document.getElementById('validationStatus').textContent = 'HTML Invalid';
                    document.getElementById('validationStatus').className = 'text-red-400';
                    this.showNotification('HTML validation failed', 'error');
                } else {
                    document.getElementById('validationStatus').textContent = 'HTML Valid';
                    document.getElementById('validationStatus').className = 'text-green-400';
                    this.showNotification('HTML is valid', 'success');
                }
            }

            exportPage() {
                if (!this.currentFile) return;
                
                const html = this.editor.getValue();
                this.fileManager.downloadFile(this.currentFile, html);
            }

            addToRecentFiles(filename) {
                this.recentFiles = this.recentFiles.filter(f => f !== filename);
                this.recentFiles.unshift(filename);
                this.recentFiles = this.recentFiles.slice(0, 5);
                
                localStorage.setItem('buildly-recent-pages', JSON.stringify(this.recentFiles));
                this.updateRecentFiles();
            }

            updateRecentFiles() {
                const container = document.getElementById('recentFiles');
                if (this.recentFiles.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">No recent files</p>';
                    return;
                }

                container.innerHTML = this.recentFiles.map(file => 
                    `<button class="text-sm text-buildly-primary hover:text-buildly-secondary block w-full text-left py-1" 
                       onclick="pageEditor.loadFile('${file}')">${file}</button>`
                ).join('');
            }

            showNotification(message, type = 'info') {
                // Create a simple notification
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md z-50 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                } text-white`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        }

        // Error handlers for uncaught errors
        window.addEventListener('error', (e) => {
            console.log('Caught error:', e.error);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.log('Caught unhandled promise rejection:', e.reason);
            e.preventDefault(); // Prevent the error from appearing in console
        });

        // Load navigation and initialize the page editor
        let pageEditor;
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM Content Loaded - initializing page editor');
            console.log('Available elements:', {
                adminNav: document.getElementById('admin-nav'),
                fileSelect: document.getElementById('fileSelect'),
                htmlEditor: document.getElementById('htmlEditor')
            });
            
            // Load navigation
            try {
                console.log('Loading navigation...');
                const response = await fetch('includes/nav.html');
                if (response.ok) {
                    const navHtml = await response.text();
                    const navContainer = document.getElementById('admin-nav');
                    if (navContainer) {
                        navContainer.innerHTML = navHtml;
                        console.log('Navigation loaded successfully');
                    } else {
                        console.error('Navigation container not found');
                    }
                } else {
                    console.error('Failed to fetch navigation:', response.status);
                }
            } catch (error) {
                console.error('Failed to load navigation:', error);
            }
            
            // Initialize page editor after a short delay to ensure DOM is ready
            setTimeout(() => {
                pageEditor = new PageEditor();
            }, 100);
        });
    </script>
</body>
</html>